#include "func_server.hpp"

int main() {
	// 1. Crear socket del servidor
	int serverFd = createNBSocket();
	if (serverFd < 0) {
		cerr << "[ERROR] No se pudo crear socket del servidor\n";
		return 1;
	}

	// 2. Crear instancia de epoll
	int epollFd = epoll_create1(0);
	if (epollFd < 0) {
		cerr << "[ERROR] No se pudo crear epoll\n";
		close(serverFd);
		unlink(SOCKET_PATH);
		return 1;
	}

	cout << "[SERVER] Epoll creado correctamente\n";

	// 3. Agregar socket del servidor al epoll
	if (addSocketToEpoll(epollFd, serverFd, EPOLLIN) < 0) {
		close(epollFd);
		close(serverFd);
		unlink(SOCKET_PATH);
		return 1;
	}

	cout << "[SERVER] Servidor listo, esperando conexiones...\n";

	// 4. Array de eventos
	struct epoll_event events[MAX_EVENTS];

	// 5. Bucle principal
	while (true) {
		// Esperar eventos (bloqueante hasta que llegue algo)
		int nfds = epoll_wait(epollFd, events, MAX_EVENTS, -1); // Number of file descriptors

		if (nfds < 0) {
			cerr << "[ERROR] Error en epoll_wait\n";
			break;
		}

		// Procesar todos los eventos
		for (int i = 0; i < nfds; i++) {
			int connectionFd = events[i].data.fd;
			uint32_t event = events[i].events;
			// Evento en el servidor = nueva conexión
			if (connectionFd == serverFd) {
				// Aceptar todas las conexiones pendientes
				while (true) {
					if (acceptNewClient(serverFd, epollFd) < 1) {
						break;
					}
				}
				continue;
			}

			if (event & EPOLLIN) {
				int messageReady = receiveFromClient(connectionFd, epollFd);
				if (messageReady == 1) { // Hay mensaje
					// Comprobación mínima para el comando "add" sin cambiar el flujo original
					string tmp = client_buffers[connectionFd];
					// Normalizar: quitar espacios inicial/final y CR/LF
					tmp = trim(tmp);
					if (!tmp.empty() && tmp.back() == '\r') tmp.pop_back();

					if (tmp == "add") {
						cout << "[SERVER] Comando 'add' recibido en FD " << connectionFd << "\n";

						// Línea hardcoded a insertar (modifícala si quieres otra)
						const string hardcoded_line = R"(81,1580572439333.0,931.0,4125181013.0,CLASSIC,MATCHED_GAME,10.2.305.4739,11.0,"[{'participantId': 1, 'player': {'platformId': 'KR', 'accountId': '2bQVJWIZRCze73cE2tm2iEX-pg1y5MuwtkQPs4esynaGILQ', 'summonerName': 'HOLAPROFE', 'summonerId': '_G5p3j8X2d-tKU-JXLco7_EWg33mt2SinfJOW_aGWgNep1Y', 'currentPlatformId': 'KR', 'currentAccountId': '2bQVJWIZRCze73cE2tm2iEX-pg1y5MuwtkQPs4esynaGILQ', 'matchHistoryUri': '/v1/stats/player_history/KR/209288701', 'profileIcon': 4463}}, {'participantId': 2, 'player': {'platformId': 'KR', 'accountId': '6K8m_ynxEtKDTduCcLGi6ir6T41AwYeT5BtPZygcPVD6zok', 'summonerName': '칼과 창 방패', 'summonerId': '0B21cSDhS1ZA4a_Vl5MOZfXOSSMu5cryoBSuLTcpL8y-GWg', 'currentPlatformId': 'KR', 'currentAccountId': '6K8m_ynxEtKDTduCcLGi6ir6T41AwYeT5BtPZygcPVD6zok', 'matchHistoryUri': '/v1/stats/player_history/KR/209791125', 'profileIcon': 3495}}, {'participantId': 3, 'player': {'platformId': 'KR', 'accountId': 'DjIE1n5PMoKnv2FfYDK-oLgN5szizVnwqGt-l_DAbKLEKEk', 'summonerName': 'DRX Pyosik', 'summonerId': 'sT6UIdRhEE6qvHLT6BO0rp52V_ocmsxb1q8RXEs2R9Kdlmo', 'currentPlatformId': 'KR', 'currentAccountId': 'DjIE1n5PMoKnv2FfYDK-oLgN5szizVnwqGt-l_DAbKLEKEk', 'matchHistoryUri': '/v1/stats/player_history/KR/201412938', 'profileIcon': 10}}, {'participantId': 4, 'player': {'platformId': 'KR', 'accountId': 'RpfEsn4uy31t7jaK4jiAlINRVeFqbcK3fXanABDw9KIQloc', 'summonerName': '꿈의 남자', 'summonerId': 'P9oKEXsIW-putU_nwPf8S8WBHcaWtHKOxaxUKT33kKU_aBU', 'currentPlatformId': 'KR', 'currentAccountId': 'RpfEsn4uy31t7jaK4jiAlINRVeFqbcK3fXanABDw9KIQloc', 'matchHistoryUri': '/v1/stats/player_history/KR/209296297', 'profileIcon': 7}}, {'participantId': 5, 'player': {'platformId': 'KR', 'accountId': 'RrvfcV7fCqu7JZKEDJuZ56jjcipVZg-ZFrVOR4bq4uiGF-g', 'summonerName': 'HLE Migung', 'summonerId': 'LkQFNBeszl0-BSEVw1f3nZ5GSr6-b785O1epzxtzNtayV7w', 'currentPlatformId': 'KR', 'currentAccountId': 'RrvfcV7fCqu7JZKEDJuZ56jjcipVZg-ZFrVOR4bq4uiGF-g', 'matchHistoryUri': '/v1/stats/player_history/KR/202447485', 'profileIcon': 4449}}, {'participantId': 6, 'player': {'platformId': 'KR', 'accountId': 'SFhyPZQFvBgT819H3v5wj6v0wctdBNUOmYKWBnaTghwKWRU', 'summonerName': 'SPG DalkA', 'summonerId': 'PwKsv6pt2ODcmQ0AgY1DB9MqmmoUuDOnJJXgKM016xVhdpA', 'currentPlatformId': 'KR', 'currentAccountId': 'SFhyPZQFvBgT819H3v5wj6v0wctdBNUOmYKWBnaTghwKWRU', 'matchHistoryUri': '/v1/stats/player_history/KR/209498975', 'profileIcon': 4379}}, {'participantId': 7, 'player': {'platformId': 'KR', 'accountId': '-fIO9kid9UOaNLEIO9cFp7gm3niBuwGIcehMskHoDuXpV8ufxuB9toXV', 'summonerName': 'SRB Harp', 'summonerId': 'lPlTICvuusxA5K7H55B0XTNO89KCPMxjQy49YW1gee7UFm8', 'currentPlatformId': 'KR', 'currentAccountId': '-fIO9kid9UOaNLEIO9cFp7gm3niBuwGIcehMskHoDuXpV8ufxuB9toXV', 'matchHistoryUri': '/v1/stats/player_history/KR/1982814430350688', 'profileIcon': 7}}, {'participantId': 8, 'player': {'platformId': 'KR', 'accountId': 'JTPl-LVM05a-cd5mTYUd0dcmwBahqORrbGTr1aHtJu2ALKE', 'summonerName': 'Gen G Clid', 'summonerId': 'th78mli66hihVN8_bawLajrGalnASfmmYYtEZ-x62tm6vbc', 'currentPlatformId': 'KR', 'currentAccountId': 'JTPl-LVM05a-cd5mTYUd0dcmwBahqORrbGTr1aHtJu2ALKE', 'matchHistoryUri': '/v1/stats/player_history/KR/203870735', 'profileIcon': 1445}}, {'participantId': 9, 'player': {'platformId': 'KR', 'accountId': 'RR7BAS_9EcrIL1jX6kDmbjsGXjX0yWzbeSa4mgE1AK0aZJ0', 'summonerName': ' Gen G Bdd', 'summonerId': 'hCD9MSGyo18MU5ctypyFPfpg4k9YDfFnLxUtc6w0M2e3BNY', 'currentPlatformId': 'KR', 'currentAccountId': 'RR7BAS_9EcrIL1jX6kDmbjsGXjX0yWzbeSa4mgE1AK0aZJ0', 'matchHistoryUri': '/v1/stats/player_history/KR/204802627', 'profileIcon': 6}}, {'participantId': 10, 'player': {'platformId': 'KR', 'accountId': 'IIWG7FRiqE8CuZaCslKkNxkglwpgnePPxDslb2tv66FKrgo', 'summonerName': 'Thal Youtube구독', 'summonerId': '8Cx100isJ6RMMeOmUX_-Wg0CESabVTYk-e8P8Ijj3zuIiB4', 'currentPlatformId': 'KR', 'currentAccountId': 'IIWG7FRiqE8CuZaCslKkNxkglwpgnePPxDslb2tv66FKrgo', 'matchHistoryUri': '/v1/stats/player_history/KR/201236882', 'profileIcon': 551}}]","[{'participantId': 1, 'teamId': 100, 'championId': 163, 'spell1Id': 7, 'spell2Id': 4, 'stats': {'participantId': 1, 'win': False, 'item0': 0, 'item1': 1056, 'item2': 1082, 'item3': 3285, 'item4': 3020, 'item5': 1052, 'item6': 3340, 'kills': 4, 'deaths': 3, 'assists': 1, 'largestKillingSpree': 2, 'largestMultiKill': 1, 'killingSprees': 1, 'longestTimeSpentLiving': 448, 'doubleKills': 0, 'tripleKills': 0, 'quadraKills': 0, 'pentaKills': 0, 'unrealKills': 0, 'totalDamageDealt': 40676, 'magicDamageDealt': 34709, 'physicalDamageDealt': 4349, 'trueDamageDealt': 1617, 'largestCriticalStrike': 0, 'totalDamageDealtToChampions': 4575, 'magicDamageDealtToChampions': 3906, 'physicalDamageDealtToChampions': 531, 'trueDamageDealtToChampions': 137, 'totalHeal': 1023, 'totalUnitsHealed': 2, 'damageSelfMitigated': 1726, 'damageDealtToObjectives': 669, 'damageDealtToTurrets': 334, 'visionScore': 14, 'timeCCingOthers': 5, 'totalDamageTaken': 5960, 'magicalDamageTaken': 1778, 'physicalDamageTaken': 3836, 'trueDamageTaken': 346, 'goldEarned': 6245, 'goldSpent': 6060, 'turretKills': 0, 'inhibitorKills': 0, 'totalMinionsKilled': 87, 'neutralMinionsKilled': 2, 'neutralMinionsKilledTeamJungle': 1, 'neutralMinionsKilledEnemyJungle': 0, 'totalTimeCrowdControlDealt': 200, 'champLevel': 8, 'visionWardsBoughtInGame': 5, 'sightWardsBoughtInGame': 0, 'wardsPlaced': 7, 'wardsKilled': 2, 'firstBloodKill': True, 'firstBloodAssist': False, 'firstTowerKill': False, 'firstTowerAssist': False, 'combatPlayerScore': 0, 'objectivePlayerScore': 0, 'totalPlayerScore': 0, 'totalScoreRank': 0, 'playerScore0': 0, 'playerScore1': 0, 'playerScore2': 0, 'playerScore3': 0, 'playerScore4': 0, 'playerScore5': 0, 'playerScore6': 0, 'playerScore7': 0, 'playerScore8': 0, 'playerScore9': 0, 'perk0': 8128, 'perk0Var1': 313, 'perk0Var2': 7, 'perk0Var3': 603, 'perk1': 8126, 'perk1Var1': 137, 'perk1Var2': 0, 'perk1Var3': 0, 'perk2': 8138, 'perk2Var1': 10, 'perk2Var2': 0, 'perk2Var3': 0, 'perk3': 8135, 'perk3Var1': 894, 'perk3Var2': 3, 'perk3Var3': 0, 'perk4': 8009, 'perk4Var1': 535, 'perk4Var2': 500, 'perk4Var3': 0, 'perk5': 8014, 'perk5Var1': 96, 'perk5Var2': 0, 'perk5Var3': 0, 'perkPrimaryStyle': 8100, 'perkSubStyle': 8000, 'statPerk0': 5008, 'statPerk1': 5008, 'statPerk2': 5002}, 'timeline': {'participantId': 1, 'creepsPerMinDeltas': {'0-10': 6.4}, 'xpPerMinDeltas': {'0-10': 343.2}, 'goldPerMinDeltas': {'0-10': 399.6}, 'csDiffPerMinDeltas': {'0-10': -0.4800000000000002}, 'xpDiffPerMinDeltas': {'0-10': -27.439999999999998}, 'damageTakenPerMinDeltas': {'0-10': 324.6}, 'damageTakenDiffPerMinDeltas': {'0-10': 113.22000000000003}, 'role': 'DUO_SUPPORT', 'lane': 'NONE'}}, {'participantId': 2, 'teamId': 100, 'championId': 78, 'spell1Id': 12, 'spell2Id': 4, 'stats': {'participantId': 2, 'win': False, 'item0': 1055, 'item1': 2033, 'item2': 3047, 'item3': 3751, 'item4': 1028, 'item5': 1029, 'item6': 3340, 'kills': 0, 'deaths': 7, 'assists': 1, 'largestKillingSpree': 0, 'largestMultiKill': 0, 'killingSprees': 0, 'longestTimeSpentLiving': 229, 'doubleKills': 0, 'tripleKills': 0, 'quadraKills': 0, 'pentaKills': 0, 'unrealKills': 0, 'totalDamageDealt': 41367, 'magicDamageDealt': 3315, 'physicalDamageDealt': 31811, 'trueDamageDealt': 6240, 'largestCriticalStrike': 0, 'totalDamageDealtToChampions': 5411, 'magicDamageDealtToChampions': 1074, 'physicalDamageDealtToChampions': 4337, 'trueDamageDealtToChampions': 0, 'totalHeal': 1143, 'totalUnitsHealed': 1, 'damageSelfMitigated': 8691, 'damageDealtToObjectives': 121, 'damageDealtToTurrets': 0, 'visionScore': 3, 'timeCCingOthers': 13, 'totalDamageTaken': 11689, 'magicalDamageTaken': 3978, 'physicalDamageTaken': 7233, 'trueDamageTaken': 477, 'goldEarned': 4231, 'goldSpent': 4075, 'turretKills': 0, 'inhibitorKills': 0, 'totalMinionsKilled': 84, 'neutralMinionsKilled': 0, 'neutralMinionsKilledTeamJungle': 0, 'neutralMinionsKilledEnemyJungle': 0, 'totalTimeCrowdControlDealt': 208, 'champLevel': 9, 'visionWardsBoughtInGame': 1, 'sightWardsBoughtInGame': 0, 'wardsPlaced': 5, 'wardsKilled': 2, 'firstBloodKill': False, 'firstBloodAssist': False, 'firstTowerKill': False, 'firstTowerAssist': False, 'combatPlayerScore': 0, 'objectivePlayerScore': 0, 'totalPlayerScore': 0, 'totalScoreRank': 0, 'playerScore0': 0, 'playerScore1': 0, 'playerScore2': 0, 'playerScore3': 0, 'playerScore4': 0, 'playerScore5': 0, 'playerScore6': 0, 'playerScore7': 0, 'playerScore8': 0, 'playerScore9': 0, 'perk0': 8437, 'perk0Var1': 275, 'perk0Var2': 192, 'perk0Var3': 0, 'perk1': 8401, 'perk1Var1': 30, 'perk1Var2': 0, 'perk1Var3': 0, 'perk2': 8473, 'perk2Var1': 527, 'perk2Var2': 0, 'perk2Var3': 0, 'perk3': 8453, 'perk3Var1': 84, 'perk3Var2': 171, 'perk3Var3': 0, 'perk4': 8345, 'perk4Var1': 3, 'perk4Var2': 0, 'perk4Var3': 0, 'perk5': 8352, 'perk5Var1': 174, 'perk5Var2': 963, 'perk5Var3': 512, 'perkPrimaryStyle': 8400, 'perkSubStyle': 8300, 'statPerk0': 5008, 'statPerk1': 5008, 'statPerk2': 5002}, 'timeline': {'participantId': 2, 'creepsPerMinDeltas': {'0-10': 6}, 'xpPerMinDeltas': {'0-10': 387.3}, 'goldPerMinDeltas': {'0-10': 239.7}, 'csDiffPerMinDeltas': {'0-10': -0.4800000000000002}, 'xpDiffPerMinDeltas': {'0-10': -27.439999999999998}, 'damageTakenPerMinDeltas': {'0-10': 635.3}, 'damageTakenDiffPerMinDeltas': {'0-10': 113.22000000000003}, 'role': 'DUO_SUPPORT', 'lane': 'NONE'}}, {'participantId': 3, 'teamId': 100, 'championId': 5, 'spell1Id': 11, 'spell2Id': 4, 'stats': {'participantId': 3, 'win': False, 'item0': 1412, 'item1': 2031, 'item2': 3044, 'item3': 2055, 'item4': 3067, 'item5': 3111, 'item6': 3364, 'kills': 2, 'deaths': 2, 'assists': 2, 'largestKillingSpree': 0, 'largestMultiKill': 1, 'killingSprees': 0, 'longestTimeSpentLiving': 308, 'doubleKills': 0, 'tripleKills': 0, 'quadraKills': 0, 'pentaKills': 0, 'unrealKills': 0, 'totalDamageDealt': 82721, 'magicDamageDealt': 7820, 'physicalDamageDealt': 68656, 'trueDamageDealt': 6243, 'largestCriticalStrike': 0, 'totalDamageDealtToChampions': 4287, 'magicDamageDealtToChampions': 261, 'physicalDamageDealtToChampions': 3640, 'trueDamageDealtToChampions': 385, 'totalHeal': 7438, 'totalUnitsHealed': 1, 'damageSelfMitigated': 6126, 'damageDealtToObjectives': 11134, 'damageDealtToTurrets': 401, 'visionScore': 17, 'timeCCingOthers': 6, 'totalDamageTaken': 12306, 'magicalDamageTaken': 2270, 'physicalDamageTaken': 9939, 'trueDamageTaken': 96, 'goldEarned': 6389, 'goldSpent': 6150, 'turretKills': 1, 'inhibitorKills': 0, 'totalMinionsKilled': 17, 'neutralMinionsKilled': 87, 'neutralMinionsKilledTeamJungle': 60, 'neutralMinionsKilledEnemyJungle': 1, 'totalTimeCrowdControlDealt': 342, 'champLevel': 9, 'visionWardsBoughtInGame': 3, 'sightWardsBoughtInGame': 0, 'wardsPlaced': 2, 'wardsKilled': 5, 'firstBloodKill': False, 'firstBloodAssist': False, 'firstTowerKill': True, 'firstTowerAssist': False, 'combatPlayerScore': 0, 'objectivePlayerScore': 0, 'totalPlayerScore': 0, 'totalScoreRank': 0, 'playerScore0': 0, 'playerScore1': 0, 'playerScore2': 0, 'playerScore3': 0, 'playerScore4': 0, 'playerScore5': 0, 'playerScore6': 0, 'playerScore7': 0, 'playerScore8': 0, 'playerScore9': 0, 'perk0': 8010, 'perk0Var1': 140, 'perk0Var2': 0, 'perk0Var3': 0, 'perk1': 9111, 'perk1Var1': 195, 'perk1Var2': 80, 'perk1Var3': 0, 'perk2': 9105, 'perk2Var1': 13, 'perk2Var2': 40, 'perk2Var3': 0, 'perk3': 8014, 'perk3Var1': 81, 'perk3Var2': 0, 'perk3Var3': 0, 'perk4': 8275, 'perk4Var1': 9, 'perk4Var2': 0, 'perk4Var3': 0, 'perk5': 8232, 'perk5Var1': 2, 'perk5Var2': 30, 'perk5Var3': 0, 'perkPrimaryStyle': 8000, 'perkSubStyle': 8200, 'statPerk0': 5005, 'statPerk1': 5008, 'statPerk2': 5002}, 'timeline': {'participantId': 3, 'creepsPerMinDeltas': {'0-10': 0.2}, 'xpPerMinDeltas': {'0-10': 327.4}, 'goldPerMinDeltas': {'0-10': 399.9}, 'csDiffPerMinDeltas': {'0-10': -0.4800000000000002}, 'xpDiffPerMinDeltas': {'0-10': -27.439999999999998}, 'damageTakenPerMinDeltas': {'0-10': 825.4}, 'damageTakenDiffPerMinDeltas': {'0-10': 113.22000000000003}, 'role': 'DUO_SUPPORT', 'lane': 'NONE'}}, {'participantId': 4, 'teamId': 100, 'championId': 9, 'spell1Id': 14, 'spell2Id': 4, 'stats': {'participantId': 4, 'win': False, 'item0': 2424, 'item1': 3851, 'item2': 3108, 'item3': 3191, 'item4': 0, 'item5': 3117, 'item6': 3364, 'kills': 0, 'deaths': 5, 'assists': 4, 'largestKillingSpree': 0, 'largestMultiKill': 0, 'killingSprees': 0, 'longestTimeSpentLiving': 222, 'doubleKills': 0, 'tripleKills': 0, 'quadraKills': 0, 'pentaKills': 0, 'unrealKills': 0, 'totalDamageDealt': 13321, 'magicDamageDealt': 11453, 'physicalDamageDealt': 1505, 'trueDamageDealt': 362, 'largestCriticalStrike': 0, 'totalDamageDealtToChampions': 3413, 'magicDamageDealtToChampions': 2903, 'physicalDamageDealtToChampions': 147, 'trueDamageDealtToChampions': 362, 'totalHeal': 457, 'totalUnitsHealed': 1, 'damageSelfMitigated': 3082, 'damageDealtToObjectives': 780, 'damageDealtToTurrets': 780, 'visionScore': 16, 'timeCCingOthers': 41, 'totalDamageTaken': 5995, 'magicalDamageTaken': 1985, 'physicalDamageTaken': 3776, 'trueDamageTaken': 234, 'goldEarned': 3759, 'goldSpent': 3625, 'turretKills': 0, 'inhibitorKills': 0, 'totalMinionsKilled': 9, 'neutralMinionsKilled': 0, 'neutralMinionsKilledTeamJungle': 0, 'neutralMinionsKilledEnemyJungle': 0, 'totalTimeCrowdControlDealt': 138, 'champLevel': 7, 'visionWardsBoughtInGame': 3, 'sightWardsBoughtInGame': 0, 'wardsPlaced': 10, 'wardsKilled': 6, 'firstBloodKill': False, 'firstBloodAssist': False, 'firstTowerKill': False, 'firstTowerAssist': False, 'combatPlayerScore': 0, 'objectivePlayerScore': 0, 'totalPlayerScore': 0, 'totalScoreRank': 0, 'playerScore0': 0, 'playerScore1': 0, 'playerScore2': 0, 'playerScore3': 0, 'playerScore4': 0, 'playerScore5': 0, 'playerScore6': 0, 'playerScore7': 0, 'playerScore8': 0, 'playerScore9': 0, 'perk0': 8439, 'perk0Var1': 99, 'perk0Var2': 0, 'perk0Var3': 0, 'perk1': 8446, 'perk1Var1': 474, 'perk1Var2': 0, 'perk1Var3': 0, 'perk2': 8473, 'perk2Var1': 301, 'perk2Var2': 0, 'perk2Var3': 0, 'perk3': 8242, 'perk3Var1': 6, 'perk3Var2': 0, 'perk3Var3': 0, 'perk4': 8313, 'perk4Var1': 0, 'perk4Var2': 0, 'perk4Var3': 0, 'perk5': 8345, 'perk5Var1': 3, 'perk5Var2': 0, 'perk5Var3': 0, 'perkPrimaryStyle': 8400, 'perkSubStyle': 8300, 'statPerk0': 5008, 'statPerk1': 5008, 'statPerk2': 5002}, 'timeline': {'participantId': 4, 'creepsPerMinDeltas': {'0-10': 0.2}, 'xpPerMinDeltas': {'0-10': 232.1}, 'goldPerMinDeltas': {'0-10': 202.60000000000002}, 'csDiffPerMinDeltas': {'0-10': -0.4800000000000002}, 'xpDiffPerMinDeltas': {'0-10': -27.439999999999998}, 'damageTakenPerMinDeltas': {'0-10': 366.4}, 'damageTakenDiffPerMinDeltas': {'0-10': 113.22000000000003}, 'role': 'DUO_SUPPORT', 'lane': 'NONE'}}, {'participantId': 5, 'teamId': 100, 'championId': 85, 'spell1Id': 12, 'spell2Id': 4, 'stats': {'participantId': 5, 'win': False, 'item0': 3152, 'item1': 1026, 'item2': 3020, 'item3': 3108, 'item4': 1052, 'item5': 0, 'item6': 3340, 'kills': 1, 'deaths': 2, 'assists': 0, 'largestKillingSpree': 0, 'largestMultiKill': 1, 'killingSprees': 0, 'longestTimeSpentLiving': 569, 'doubleKills': 0, 'tripleKills': 0, 'quadraKills': 0, 'pentaKills': 0, 'unrealKills': 0, 'totalDamageDealt': 62009, 'magicDamageDealt': 48098, 'physicalDamageDealt': 13910, 'trueDamageDealt': 0, 'largestCriticalStrike': 0, 'totalDamageDealtToChampions': 4064, 'magicDamageDealtToChampions': 2800, 'physicalDamageDealtToChampions': 1264, 'trueDamageDealtToChampions': 0, 'totalHeal': 662, 'totalUnitsHealed': 1, 'damageSelfMitigated': 2898, 'damageDealtToObjectives': 2636, 'damageDealtToTurrets': 2636, 'visionScore': 12, 'timeCCingOthers': 8, 'totalDamageTaken': 6402, 'magicalDamageTaken': 2381, 'physicalDamageTaken': 3980, 'trueDamageTaken': 40, 'goldEarned': 6764, 'goldSpent': 6560, 'turretKills': 1, 'inhibitorKills': 0, 'totalMinionsKilled': 138, 'neutralMinionsKilled': 0, 'neutralMinionsKilledTeamJungle': 0, 'neutralMinionsKilledEnemyJungle': 0, 'totalTimeCrowdControlDealt': 32, 'champLevel': 11, 'visionWardsBoughtInGame': 3, 'sightWardsBoughtInGame': 0, 'wardsPlaced': 8, 'wardsKilled': 2, 'firstBloodKill': False, 'firstBloodAssist': False, 'firstTowerKill': False, 'firstTowerAssist': True, 'combatPlayerScore': 0, 'objectivePlayerScore': 0, 'totalPlayerScore': 0, 'totalScoreRank': 0, 'playerScore0': 0, 'playerScore1': 0, 'playerScore2': 0, 'playerScore3': 0, 'playerScore4': 0, 'playerScore5': 0, 'playerScore6': 0, 'playerScore7': 0, 'playerScore8': 0, 'playerScore9': 0, 'perk0': 8010, 'perk0Var1': 26, 'perk0Var2': 0, 'perk0Var3': 0, 'perk1': 8009, 'perk1Var1': 40, 'perk1Var2': 10, 'perk1Var3': 0, 'perk2': 9104, 'perk2Var1': 0, 'perk2Var2': 0, 'perk2Var3': 0, 'perk3': 8014, 'perk3Var1': 53, 'perk3Var2': 0, 'perk3Var3': 0, 'perk4': 8210, 'perk4Var1': 0, 'perk4Var2': 0, 'perk4Var3': 0, 'perk5': 8275, 'perk5Var1': 3, 'perk5Var2': 0, 'perk5Var3': 0, 'perkPrimaryStyle': 8000, 'perkSubStyle': 8200, 'statPerk0': 5007, 'statPerk1': 5008, 'statPerk2': 5003}, 'timeline': {'participantId': 5, 'creepsPerMinDeltas': {'0-10': 7.699999999999999}, 'xpPerMinDeltas': {'0-10': 453}, 'goldPerMinDeltas': {'0-10': 358.4}, 'csDiffPerMinDeltas': {'0-10': -0.4800000000000002}, 'xpDiffPerMinDeltas': {'0-10': -27.439999999999998}, 'damageTakenPerMinDeltas': {'0-10': 360.2}, 'damageTakenDiffPerMinDeltas': {'0-10': 113.22000000000003}, 'role': 'DUO', 'lane': 'NONE'}}, {'participantId': 6, 'teamId': 200, 'championId': 21, 'spell1Id': 4, 'spell2Id': 1, 'stats': {'participantId': 6, 'win': True, 'item0': 3142, 'item1': 1056, 'item2': 3814, 'item3': 1001, 'item4': 3134, 'item5': 1036, 'item6': 3363, 'kills': 6, 'deaths': 1, 'assists': 6, 'largestKillingSpree': 3, 'largestMultiKill': 2, 'killingSprees': 2, 'longestTimeSpentLiving': 428, 'doubleKills': 2, 'tripleKills': 0, 'quadraKills': 0, 'pentaKills': 0, 'unrealKills': 0, 'totalDamageDealt': 61578, 'magicDamageDealt': 3169, 'physicalDamageDealt': 58408, 'trueDamageDealt': 0, 'largestCriticalStrike': 694, 'totalDamageDealtToChampions': 7642, 'magicDamageDealtToChampions': 1099, 'physicalDamageDealtToChampions': 6543, 'trueDamageDealtToChampions': 0, 'totalHeal': 0, 'totalUnitsHealed': 0, 'damageSelfMitigated': 2017, 'damageDealtToObjectives': 6796, 'damageDealtToTurrets': 6796, 'visionScore': 10, 'timeCCingOthers': 4, 'totalDamageTaken': 3946, 'magicalDamageTaken': 2329, 'physicalDamageTaken': 1478, 'trueDamageTaken': 138, 'goldEarned': 8246, 'goldSpent': 8050, 'turretKills': 1, 'inhibitorKills': 0, 'totalMinionsKilled': 129, 'neutralMinionsKilled': 0, 'neutralMinionsKilledTeamJungle': 0, 'neutralMinionsKilledEnemyJungle': 0, 'totalTimeCrowdControlDealt': 74, 'champLevel': 10, 'visionWardsBoughtInGame': 0, 'sightWardsBoughtInGame': 0, 'wardsPlaced': 4, 'wardsKilled': 3, 'firstBloodKill': False, 'firstBloodAssist': False, 'firstTowerKill': False, 'firstTowerAssist': False, 'combatPlayerScore': 0, 'objectivePlayerScore': 0, 'totalPlayerScore': 0, 'totalScoreRank': 0, 'playerScore0': 0, 'playerScore1': 0, 'playerScore2': 0, 'playerScore3': 0, 'playerScore4': 0, 'playerScore5': 0, 'playerScore6': 0, 'playerScore7': 0, 'playerScore8': 0, 'playerScore9': 0, 'perk0': 8229, 'perk0Var1': 557, 'perk0Var2': 0, 'perk0Var3': 0, 'perk1': 8226, 'perk1Var1': 250, 'perk1Var2': 345, 'perk1Var3': 0, 'perk2': 8233, 'perk2Var1': 5, 'perk2Var2': 10, 'perk2Var3': 0, 'perk3': 8237, 'perk3Var1': 232, 'perk3Var2': 0, 'perk3Var3': 0, 'perk4': 9103, 'perk4Var1': 0, 'perk4Var2': 0, 'perk4Var3': 0, 'perk5': 9101, 'perk5Var1': 384, 'perk5Var2': 731, 'perk5Var3': 0, 'perkPrimaryStyle': 8200, 'perkSubStyle': 8000, 'statPerk0': 5008, 'statPerk1': 5008, 'statPerk2': 5003}, 'timeline': {'participantId': 6, 'creepsPerMinDeltas': {'0-10': 7.1}, 'xpPerMinDeltas': {'0-10': 334.8}, 'goldPerMinDeltas': {'0-10': 352.4}, 'csDiffPerMinDeltas': {'0-10': 0.4800000000000002}, 'xpDiffPerMinDeltas': {'0-10': 27.439999999999998}, 'damageTakenPerMinDeltas': {'0-10': 296.2}, 'damageTakenDiffPerMinDeltas': {'0-10': -113.22000000000003}, 'role': 'DUO_SUPPORT', 'lane': 'NONE'}}, {'participantId': 7, 'teamId': 200, 'championId': 412, 'spell1Id': 4, 'spell2Id': 14, 'stats': {'participantId': 7, 'win': True, 'item0': 3855, 'item1': 3193, 'item2': 2055, 'item3': 3117, 'item4': 0, 'item5': 0, 'item6': 3364, 'kills': 1, 'deaths': 2, 'assists': 12, 'largestKillingSpree': 0, 'largestMultiKill': 1, 'killingSprees': 0, 'longestTimeSpentLiving': 228, 'doubleKills': 0, 'tripleKills': 0, 'quadraKills': 0, 'pentaKills': 0, 'unrealKills': 0, 'totalDamageDealt': 13617, 'magicDamageDealt': 3904, 'physicalDamageDealt': 4288, 'trueDamageDealt': 5424, 'largestCriticalStrike': 0, 'totalDamageDealtToChampions': 2619, 'magicDamageDealtToChampions': 1793, 'physicalDamageDealtToChampions': 436, 'trueDamageDealtToChampions': 390, 'totalHeal': 64, 'totalUnitsHealed': 1, 'damageSelfMitigated': 2370, 'damageDealtToObjectives': 1305, 'damageDealtToTurrets': 1305, 'visionScore': 18, 'timeCCingOthers': 13, 'totalDamageTaken': 4122, 'magicalDamageTaken': 2526, 'physicalDamageTaken': 1340, 'trueDamageTaken': 254, 'goldEarned': 4457, 'goldSpent': 4225, 'turretKills': 0, 'inhibitorKills': 0, 'totalMinionsKilled': 19, 'neutralMinionsKilled': 0, 'neutralMinionsKilledTeamJungle': 0, 'neutralMinionsKilledEnemyJungle': 0, 'totalTimeCrowdControlDealt': 46, 'champLevel': 8, 'visionWardsBoughtInGame': 7, 'sightWardsBoughtInGame': 0, 'wardsPlaced': 9, 'wardsKilled': 3, 'firstBloodKill': False, 'firstBloodAssist': False, 'firstTowerKill': False, 'firstTowerAssist': False, 'combatPlayerScore': 0, 'objectivePlayerScore': 0, 'totalPlayerScore': 0, 'totalScoreRank': 0, 'playerScore0': 0, 'playerScore1': 0, 'playerScore2': 0, 'playerScore3': 0, 'playerScore4': 0, 'playerScore5': 0, 'playerScore6': 0, 'playerScore7': 0, 'playerScore8': 0, 'playerScore9': 0, 'perk0': 8439, 'perk0Var1': 72, 'perk0Var2': 0, 'perk0Var3': 0, 'perk1': 8446, 'perk1Var1': 577, 'perk1Var2': 0, 'perk1Var3': 0, 'perk2': 8473, 'perk2Var1': 315, 'perk2Var2': 0, 'perk2Var3': 0, 'perk3': 8242, 'perk3Var1': 6, 'perk3Var2': 0, 'perk3Var3': 0, 'perk4': 8313, 'perk4Var1': 0, 'perk4Var2': 0, 'perk4Var3': 0, 'perk5': 8316, 'perk5Var1': 311, 'perk5Var2': 0, 'perk5Var3': 0, 'perkPrimaryStyle': 8400, 'perkSubStyle': 8300, 'statPerk0': 5008, 'statPerk1': 5003, 'statPerk2': 5001}, 'timeline': {'participantId': 7, 'creepsPerMinDeltas': {'0-10': 1.2}, 'xpPerMinDeltas': {'0-10': 242.39999999999998}, 'goldPerMinDeltas': {'0-10': 227.2}, 'csDiffPerMinDeltas': {'0-10': 0.4800000000000002}, 'xpDiffPerMinDeltas': {'0-10': 27.439999999999998}, 'damageTakenPerMinDeltas': {'0-10': 327.1}, 'damageTakenDiffPerMinDeltas': {'0-10': -113.22000000000003}, 'role': 'DUO_SUPPORT', 'lane': 'NONE'}}, {'participantId': 8, 'teamId': 200, 'championId': 60, 'spell1Id': 11, 'spell2Id': 4, 'stats': {'participantId': 8, 'win': True, 'item0': 0, 'item1': 2031, 'item2': 1414, 'item3': 3111, 'item4': 1052, 'item5': 3916, 'item6': 3364, 'kills': 6, 'deaths': 2, 'assists': 9, 'largestKillingSpree': 3, 'largestMultiKill': 1, 'killingSprees': 2, 'longestTimeSpentLiving': 423, 'doubleKills': 0, 'tripleKills': 0, 'quadraKills': 0, 'pentaKills': 0, 'unrealKills': 0, 'totalDamageDealt': 59861, 'magicDamageDealt': 39216, 'physicalDamageDealt': 17730, 'trueDamageDealt': 2914, 'largestCriticalStrike': 0, 'totalDamageDealtToChampions': 7722, 'magicDamageDealtToChampions': 5909, 'physicalDamageDealtToChampions': 1229, 'trueDamageDealtToChampions': 584, 'totalHeal': 3878, 'totalUnitsHealed': 1, 'damageSelfMitigated': 3595, 'damageDealtToObjectives': 4868, 'damageDealtToTurrets': 0, 'visionScore': 34, 'timeCCingOthers': 12, 'totalDamageTaken': 9005, 'magicalDamageTaken': 3382, 'physicalDamageTaken': 5321, 'trueDamageTaken': 301, 'goldEarned': 6475, 'goldSpent': 6085, 'turretKills': 0, 'inhibitorKills': 0, 'totalMinionsKilled': 24, 'neutralMinionsKilled': 66, 'neutralMinionsKilledTeamJungle': 52, 'neutralMinionsKilledEnemyJungle': 1, 'totalTimeCrowdControlDealt': 80, 'champLevel': 10, 'visionWardsBoughtInGame': 6, 'sightWardsBoughtInGame': 0, 'wardsPlaced': 16, 'wardsKilled': 8, 'firstBloodKill': False, 'firstBloodAssist': False, 'firstTowerKill': False, 'firstTowerAssist': False, 'combatPlayerScore': 0, 'objectivePlayerScore': 0, 'totalPlayerScore': 0, 'totalScoreRank': 0, 'playerScore0': 0, 'playerScore1': 0, 'playerScore2': 0, 'playerScore3': 0, 'playerScore4': 0, 'playerScore5': 0, 'playerScore6': 0, 'playerScore7': 0, 'playerScore8': 0, 'playerScore9': 0, 'perk0': 8112, 'perk0Var1': 641, 'perk0Var2': 0, 'perk0Var3': 0, 'perk1': 8126, 'perk1Var1': 210, 'perk1Var2': 0, 'perk1Var3': 0, 'perk2': 8136, 'perk2Var1': 10, 'perk2Var2': 30, 'perk2Var3': 0, 'perk3': 8105, 'perk3Var1': 16, 'perk3Var2': 5, 'perk3Var3': 0, 'perk4': 9105, 'perk4Var1': 8, 'perk4Var2': 20, 'perk4Var3': 0, 'perk5': 8014, 'perk5Var1': 205, 'perk5Var2': 0, 'perk5Var3': 0, 'perkPrimaryStyle': 8100, 'perkSubStyle': 8000, 'statPerk0': 5005, 'statPerk1': 5008, 'statPerk2': 5002}, 'timeline': {'participantId': 8, 'creepsPerMinDeltas': {'0-10': 1}, 'xpPerMinDeltas': {'0-10': 361}, 'goldPerMinDeltas': {'0-10': 397.29999999999995}, 'csDiffPerMinDeltas': {'0-10': 0.4800000000000002}, 'xpDiffPerMinDeltas': {'0-10': 27.439999999999998}, 'damageTakenPerMinDeltas': {'0-10': 522.4}, 'damageTakenDiffPerMinDeltas': {'0-10': -113.22000000000003}, 'role': 'DUO_SUPPORT', 'lane': 'NONE'}}, {'participantId': 9, 'teamId': 200, 'championId': 246, 'spell1Id': 4, 'spell2Id': 14, 'stats': {'participantId': 9, 'win': True, 'item0': 2033, 'item1': 0, 'item2': 3179, 'item3': 3134, 'item4': 3117, 'item5': 0, 'item6': 3364, 'kills': 4, 'deaths': 1, 'assists': 5, 'largestKillingSpree': 4, 'largestMultiKill': 1, 'killingSprees': 1, 'longestTimeSpentLiving': 304, 'doubleKills': 0, 'tripleKills': 0, 'quadraKills': 0, 'pentaKills': 0, 'unrealKills': 0, 'totalDamageDealt': 48906, 'magicDamageDealt': 4287, 'physicalDamageDealt': 44397, 'trueDamageDealt': 222, 'largestCriticalStrike': 0, 'totalDamageDealtToChampions': 6950, 'magicDamageDealtToChampions': 577, 'physicalDamageDealtToChampions': 6153, 'trueDamageDealtToChampions': 220, 'totalHeal': 1760, 'totalUnitsHealed': 1, 'damageSelfMitigated': 3499, 'damageDealtToObjectives': 0, 'damageDealtToTurrets': 0, 'visionScore': 12, 'timeCCingOthers': 15, 'totalDamageTaken': 7680, 'magicalDamageTaken': 2332, 'physicalDamageTaken': 5282, 'trueDamageTaken': 66, 'goldEarned': 5811, 'goldSpent': 5200, 'turretKills': 0, 'inhibitorKills': 0, 'totalMinionsKilled': 112, 'neutralMinionsKilled': 0, 'neutralMinionsKilledTeamJungle': 0, 'neutralMinionsKilledEnemyJungle': 0, 'totalTimeCrowdControlDealt': 73, 'champLevel': 11, 'visionWardsBoughtInGame': 4, 'sightWardsBoughtInGame': 0, 'wardsPlaced': 7, 'wardsKilled': 1, 'firstBloodKill': False, 'firstBloodAssist': False, 'firstTowerKill': False, 'firstTowerAssist': False, 'combatPlayerScore': 0, 'objectivePlayerScore': 0, 'totalPlayerScore': 0, 'totalScoreRank': 0, 'playerScore0': 0, 'playerScore1': 0, 'playerScore2': 0, 'playerScore3': 0, 'playerScore4': 0, 'playerScore5': 0, 'playerScore6': 0, 'playerScore7': 0, 'playerScore8': 0, 'playerScore9': 0, 'perk0': 8112, 'perk0Var1': 545, 'perk0Var2': 0, 'perk0Var3': 0, 'perk1': 8143, 'perk1Var1': 177, 'perk1Var2': 0, 'perk1Var3': 0, 'perk2': 8120, 'perk2Var1': 1, 'perk2Var2': 4, 'perk2Var3': 3, 'perk3': 8135, 'perk3Var1': 951, 'perk3Var2': 3, 'perk3Var3': 0, 'perk4': 8345, 'perk4Var1': 3, 'perk4Var2': 0, 'perk4Var3': 0, 'perk5': 8352, 'perk5Var1': 235, 'perk5Var2': 1014, 'perk5Var3': 725, 'perkPrimaryStyle': 8100, 'perkSubStyle': 8300, 'statPerk0': 5008, 'statPerk1': 5008, 'statPerk2': 5002}, 'timeline': {'participantId': 9, 'creepsPerMinDeltas': {'0-10': 6.5}, 'xpPerMinDeltas': {'0-10': 478.7}, 'goldPerMinDeltas': {'0-10': 296.6}, 'csDiffPerMinDeltas': {'0-10': 0.4800000000000002}, 'xpDiffPerMinDeltas': {'0-10': 27.439999999999998}, 'damageTakenPerMinDeltas': {'0-10': 457.4}, 'damageTakenDiffPerMinDeltas': {'0-10': -113.22000000000003}, 'role': 'DUO_SUPPORT', 'lane': 'NONE'}}, {'participantId': 10, 'teamId': 200, 'championId': 75, 'spell1Id': 4, 'spell2Id': 12, 'stats': {'participantId': 10, 'win': True, 'item0': 2033, 'item1': 1001, 'item2': 3078, 'item3': 0, 'item4': 0, 'item5': 0, 'item6': 3340, 'kills': 2, 'deaths': 1, 'assists': 2, 'largestKillingSpree': 2, 'largestMultiKill': 1, 'killingSprees': 1, 'longestTimeSpentLiving': 185, 'doubleKills': 0, 'tripleKills': 0, 'quadraKills': 0, 'pentaKills': 0, 'unrealKills': 0, 'totalDamageDealt': 59841, 'magicDamageDealt': 27829, 'physicalDamageDealt': 27688, 'trueDamageDealt': 4324, 'largestCriticalStrike': 0, 'totalDamageDealtToChampions': 4199, 'magicDamageDealtToChampions': 2522, 'physicalDamageDealtToChampions': 1676, 'trueDamageDealtToChampions': 0, 'totalHeal': 0, 'totalUnitsHealed': 0, 'damageSelfMitigated': 2753, 'damageDealtToObjectives': 3931, 'damageDealtToTurrets': 356, 'visionScore': 13, 'timeCCingOthers': 4, 'totalDamageTaken': 5173, 'magicalDamageTaken': 1247, 'physicalDamageTaken': 3802, 'trueDamageTaken': 124, 'goldEarned': 5846, 'goldSpent': 4758, 'turretKills': 0, 'inhibitorKills': 0, 'totalMinionsKilled': 120, 'neutralMinionsKilled': 4, 'neutralMinionsKilledTeamJungle': 1, 'neutralMinionsKilledEnemyJungle': 0, 'totalTimeCrowdControlDealt': 34, 'champLevel': 11, 'visionWardsBoughtInGame': 3, 'sightWardsBoughtInGame': 0, 'wardsPlaced': 8, 'wardsKilled': 1, 'firstBloodKill': False, 'firstBloodAssist': False, 'firstTowerKill': False, 'firstTowerAssist': False, 'combatPlayerScore': 0, 'objectivePlayerScore': 0, 'totalPlayerScore': 0, 'totalScoreRank': 0, 'playerScore0': 0, 'playerScore1': 0, 'playerScore2': 0, 'playerScore3': 0, 'playerScore4': 0, 'playerScore5': 0, 'playerScore6': 0, 'playerScore7': 0, 'playerScore8': 0, 'playerScore9': 0, 'perk0': 8230, 'perk0Var1': 4, 'perk0Var2': 0, 'perk0Var3': 0, 'perk1': 8226, 'perk1Var1': 250, 'perk1Var2': 260, 'perk1Var3': 0, 'perk2': 8210, 'perk2Var1': 0, 'perk2Var2': 0, 'perk2Var3': 0, 'perk3': 8236, 'perk3Var1': 4, 'perk3Var2': 0, 'perk3Var3': 0, 'perk4': 9105, 'perk4Var1': 14, 'perk4Var2': 50, 'perk4Var3': 0, 'perk5': 8009, 'perk5Var1': 954, 'perk5Var2': 400, 'perk5Var3': 0, 'perkPrimaryStyle': 8200, 'perkSubStyle': 8000, 'statPerk0': 5008, 'statPerk1': 5002, 'statPerk2': 5003}, 'timeline': {'participantId': 10, 'creepsPerMinDeltas': {'0-10': 7.1}, 'xpPerMinDeltas': {'0-10': 463.29999999999995}, 'goldPerMinDeltas': {'0-10': 287.5}, 'csDiffPerMinDeltas': {'0-10': 0.4800000000000002}, 'xpDiffPerMinDeltas': {'0-10': 27.439999999999998}, 'damageTakenPerMinDeltas': {'0-10': 342.7}, 'damageTakenDiffPerMinDeltas': {'0-10': -113.22000000000003}, 'role': 'DUO_SUPPORT', 'lane': 'NONE'}}]",KR,420.0,13.0,,)";
						bool ok = add_line_and_rebuild(hardcoded_line);
						string reply = ok ? string("ADDED\n") : string("ERROR_ADD\n");

						// Mantener la semántica original: escribimos la respuesta en el buffer y la enviamos
						client_buffers[connectionFd] = reply;
						sendToClient(connectionFd, client_buffers[connectionFd], epollFd);
						// No cambiamos nada más del flujo: sendToClient se encargará de cerrar/limpiar.
						continue;
					}

					// Si no es "add", mantener la lógica original
					client_buffers[connectionFd] = searchServer(client_buffers[connectionFd]); // Procesamos el mensaje sobreescribiendo lo que había antes
					sendToClient(connectionFd, client_buffers[connectionFd], epollFd);
				} else if (messageReady == -1) { // no hay mensaje
					client_buffers.erase(connectionFd); // borramos el mensaje en el map
				}
			}

			if (event & EPOLLOUT) {
				sendToClient(connectionFd, client_buffers[connectionFd], epollFd);
			}
		}
	}

	// 6. Limpieza
	close(epollFd);
	close(serverFd);
	unlink(SOCKET_PATH);

	cout << "[SERVER] Servidor cerrado\n";
	return 0;
}